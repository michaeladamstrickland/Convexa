<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scraper Job Monitor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    h1, h2 {
      color: #333;
    }
    .job-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    .job-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      border-bottom: 1px solid #eee;
      padding-bottom: 8px;
    }
    .job-title {
      font-weight: bold;
      font-size: 1.1rem;
    }
    .job-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
    }
    .status-pending {
      background-color: #FFF9C4;
      color: #F57F17;
    }
    .status-running {
      background-color: #BBDEFB;
      color: #1565C0;
    }
    .status-completed {
      background-color: #C8E6C9;
      color: #2E7D32;
    }
    .status-failed {
      background-color: #FFCDD2;
      color: #B71C1C;
    }
    .job-property {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .property-name {
      color: #666;
    }
    .property-value {
      font-weight: 500;
    }
    .job-details {
      margin-top: 12px;
      font-family: monospace;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f5f5f5;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    button {
      background-color: #2196F3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button:hover {
      background-color: #0b7dda;
    }
    .no-jobs {
      text-align: center;
      padding: 40px;
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <h1>Scraper Job Monitor</h1>
  
  <div class="controls">
    <div>
      <button id="refreshBtn">Refresh Jobs</button>
      <button id="logBtn">Log Jobs to Console</button>
    </div>
    <div id="lastUpdate"></div>
  </div>
  
  <div id="jobsContainer" class="job-grid">
    <div class="no-jobs">No active jobs found</div>
  </div>
  
  <script>
    // Update the last update time
    function updateLastUpdate() {
      const now = new Date();
      document.getElementById('lastUpdate').textContent = `Last updated: ${now.toLocaleTimeString()}`;
    }
    
    // Format duration
    function formatDuration(startTime) {
      const start = new Date(startTime);
      const now = new Date();
      const seconds = Math.floor((now - start) / 1000);
      
      if (seconds < 60) {
        return `${seconds}s`;
      } else if (seconds < 3600) {
        return `${Math.floor(seconds / 60)}m ${seconds % 60}s`;
      } else {
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        return `${hours}h ${minutes}m`;
      }
    }
    
    // Render jobs
    function renderJobs(jobs) {
      const container = document.getElementById('jobsContainer');
      
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<div class="no-jobs">No active jobs found</div>';
        return;
      }
      
      container.innerHTML = '';
      
      jobs.forEach(job => {
        const jobCard = document.createElement('div');
        jobCard.className = 'job-card';
        
        // Header
        const header = document.createElement('div');
        header.className = 'job-header';
        
        const title = document.createElement('div');
        title.className = 'job-title';
        title.textContent = `${job.type.charAt(0).toUpperCase() + job.type.slice(1)} ${job.enhanced ? 'ðŸš€' : 'ðŸ“„'}`;
        
        const status = document.createElement('div');
        status.className = `job-status status-${job.status}`;
        status.textContent = job.status.charAt(0).toUpperCase() + job.status.slice(1);
        
        header.appendChild(title);
        header.appendChild(status);
        jobCard.appendChild(header);
        
        // Properties
        const addProperty = (name, value) => {
          const prop = document.createElement('div');
          prop.className = 'job-property';
          
          const propName = document.createElement('div');
          propName.className = 'property-name';
          propName.textContent = name;
          
          const propValue = document.createElement('div');
          propValue.className = 'property-value';
          propValue.textContent = value;
          
          prop.appendChild(propName);
          prop.appendChild(propValue);
          jobCard.appendChild(prop);
        };
        
        addProperty('Job ID', job.jobId.substring(0, 8) + '...');
        addProperty('Type', `${job.type} (${job.enhanced ? 'Enhanced' : 'Standard'})`);
        addProperty('Start Time', new Date(job.startTime).toLocaleTimeString());
        addProperty('Duration', formatDuration(job.startTime));
        
        // Results or error
        if (job.status === 'completed' && job.results) {
          const resultsLength = Array.isArray(job.results) ? job.results.length : 'N/A';
          addProperty('Results', resultsLength);
        } else if (job.status === 'failed' && job.error) {
          const details = document.createElement('div');
          details.className = 'job-details';
          details.textContent = typeof job.error === 'string' ? job.error : JSON.stringify(job.error, null, 2);
          jobCard.appendChild(details);
        }
        
        container.appendChild(jobCard);
      });
    }
    
    // Fetch jobs
    async function fetchJobs() {
      try {
        const response = await fetch('/api/scraper-monitor/status');
        const data = await response.json();
        
        if (data.success) {
          renderJobs(data.jobs);
        } else {
          console.error('Failed to fetch jobs:', data.message);
        }
        
        updateLastUpdate();
      } catch (error) {
        console.error('Error fetching jobs:', error);
      }
    }
    
    // Log jobs to server console
    async function logJobs() {
      try {
        const response = await fetch('/api/scraper-monitor/log', {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Jobs logged to server console');
        }
      } catch (error) {
        console.error('Error logging jobs:', error);
      }
    }
    
    // Event listeners
    document.getElementById('refreshBtn').addEventListener('click', fetchJobs);
    document.getElementById('logBtn').addEventListener('click', logJobs);
    
    // Initial fetch
    fetchJobs();
    
    // Auto-refresh every 5 seconds
    setInterval(fetchJobs, 5000);
  </script>
</body>
</html>
