groups:
- name: convexa.rules
  rules:
  - record: convexa_error_rate_5m
    expr: |
      sum by(queue)(increase(convexa_jobs_total{status="error"}[5m]))
      /
      sum by(queue)(increase(convexa_jobs_total{stage="finish"}[5m]))
  - record: convexa_cache_hit_ratio_5m
    expr: |
      sum(increase(convexa_cache_events_total{op="get",result="hit"}[5m]))
      /
      sum(increase(convexa_cache_events_total{op="get"}[5m]))
  - record: pi1_dispositions_15m
    expr: sum by (type) (increase(dial_disposition_total[15m]))
  - record: pi1_followups_due
    expr: followups_due_gauge
  - record: pi1_followups_overdue
    expr: followups_overdue_gauge

  - alert: HighErrorRate
    expr: sum(rate(http_requests_total{status=~"5..", job="convexa"}[5m])) / sum(rate(http_requests_total{job="convexa"}[5m])) > 0.02
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "High HTTP 5xx error rate detected"
      description: "The HTTP 5xx error rate has been above 2% for 5 minutes. Current value: {{ $value | humanizePercentage }}"

  - alert: HighLatency
    expr: histogram_quantile(0.95, sum by(le, path) (rate(http_request_duration_seconds_bucket{job="convexa"}[5m]))) > 0.5
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High p95 HTTP request latency detected"
      description: "The p95 HTTP request latency has been above 500ms for 5 minutes. Current value: {{ $value }}s"

  - alert: WebhookErrorsGrowth
    expr: rate(webhook_errors_total[5m]) > 0
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Webhook errors are growing"
      description: "Webhook errors are increasing. Current rate: {{ $value }} errors/sec"

  - alert: DialDispositionStall
    expr: (time() - max(dial_disposition_total_timestamp)) > 300
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Dial disposition metric stalled"
      description: "The dial_disposition_total metric has not been updated for more than 5 minutes."

  - alert: RedisDown
    expr: redis_up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "Redis is down"
      description: "Redis instance is not reachable."

  - alert: DiskUsageHigh
    expr: node_disk_utilization > 0.8
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: "Disk usage is high"
      description: "Disk usage is above 80%. Current value: {{ $value | humanizePercentage }}"

  - alert: QuotaApproachingLimit
    expr: convexa_quota_fraction{resource="attom_api"} > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "ATTOM API quota approaching limit"
      description: "The ATTOM API quota usage is at {{ $value | humanizePercentage }}. Consider increasing the daily cap or investigating usage patterns."

  - alert: QuotaHardStop
    expr: convexa_quota_fraction{resource="attom_api"} >= 1
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: "ATTOM API quota hard stop reached"
      description: "The ATTOM API quota has reached 100%. Demo mode fallback should be active."
