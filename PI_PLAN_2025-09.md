# PI Plan: Convexa Skiptrace + Site Development (Sept–Nov 2025)

## Vision
Ship a reliable, scalable lead-gen platform with real skip-trace enrichment, transparent economics, and a polished UX that converts. Keep provider coupling thin, logging/audit strong, and delivery predictable.

## Key Outcomes (OKRs)
- O1 Data quality: ≥70% phone hit-rate on qualified leads; ≥30% email hit-rate; ≤2% demo artifacts in prod.
- O2 Throughput: Backfill 10k leads/day with P95 end-to-end < 4m; P95 provider latency < 2.5s.
- O3 Reliability: Error budget met (availability ≥ 99.5%); auto-retries for transient failures; duplicate billing prevented.
- O4 Compliance & trust: PII protection by design; least-privilege access; exportable audit trail per lead.
- O5 UX & conversion: Time-to-first-contact < 60s; call/email workflows; “Hot lead” scoring v1 live.

## Architecture adjustments
- Provider adapters
  - Keep BatchData v1 as primary; add v2 feature-flag with parity tests; keep WhitePages disabled by default, callable as opt-in.
  - Strict request/response schema guards; sanitize tokens/PII in logs.
- DB & schema
  - Single source of truth for DB path (fix duplication between `backend/data` and `backend/backend/data`); add migration to merge if needed.
  - Normalize contacts (phone_numbers, email_addresses) already present: add indexes (lead_id, created_at) for fast backfills and de-dupe.
  - Add table provider_quota_usage (exists) + scheduled reconciliation job per day.
- Caching & idempotency
  - Strong idempotency key per lead+provider+normalized-address to avoid double charges; write-through cache with TTL.
- Observability
  - Prometheus metrics: counts, latency, errors, cache hits, costs; per-provider labels. Health dashboards + alerts.
  - Log structure: correlationId per run; debug routes gated in non-prod.
- Security
  - Secrets via env/KeyVault; rotate; no tokens in logs. Role-based download access for CSVs; encrypt at rest (DB + backups).
- Batch pipeline
  - Backfill runner with chunking, concurrency controls, rate-limit backoff, and resumable checkpoints.
- Frontend
  - Lead detail page: verified contacts, source, cost; action buttons (call, email, sequence). Bulk actions & filters.

## Prioritized backlog by sprint

### Sprint 1: Stabilize skiptrace core (2 weeks)
- Consolidate DB path and add migration script to unify to `backend/data/convexa.db`.
- Add idempotency key and enforced de-dupe before call; cost-safe retries.
- Harden v1 mapping + response guard (reject empty `persons`); keep address sanitize + NJ inference.
- Metrics: service-level (requests, errors, latency P50/P95, cache-hit) and provider-level (calls, cost).
- CLI: backfill runner with resume file; verifier script output to `run_reports/`.
- Unit/integration tests for adapters and cache.

### Sprint 2: UX + operator tooling (2 weeks)
- Frontend contact panel with 3 phones/3 emails and provenance.
- Bulk CSV export UI for selected filters; artifact history view.
- Quota dashboard; daily cost summary; error drill-down (from `skip_trace_logs`).
- Alerting (quota near-limit; provider 5xx spikes; 0-hit anomaly).

### Sprint 3: Scale & performance (2 weeks)
- Concurrency controller with provider rate-awareness (token bucket); dynamic backoff.
- Pipelined backfill (read → trace → verify → export) with checkpoints and retries.
- Caching TTL policy tuning; warm cache for high-priority leads.
- DB: indices on `skip_trace_logs(created_at)`, `provider_calls(created_at)`, `phone_numbers(lead_id, created_at)`.

### Sprint 4: Compliance + enrichment expansion (2 weeks)
- PII data handling review, DSR export; redact options in exports.
- Add secondary provider as optional fallback; A/B route to measure lift vs cost.
- Email validation and carrier/type append; basic DNC flagging pipeline.

## Risks & mitigations
- Provider API shifts (v1/v2): feature-flag; contract tests; canary.
- Cost runaway: daily budget guardrail; hard-stop + notifications; per-run estimates.
- PII exposure: masked logs; encrypted backups; RBAC and need-to-know access.
- Windows shell quirks: standardize Node-based runners; provide bash and PowerShell wrappers.
- Data quality variance: address normalization pipeline; confidence scoring; sampling QA.

## Milestones
- M1 (end Sprint 1): Stable v1 pipeline, metrics, backfill+verify, single DB path.
- M2 (end Sprint 2): Operator dashboard + export UI; quota and error views; alerting.
- M3 (end Sprint 3): 10k/day throughput; P95 < 4m; verified DB indices.
- M4 (end Sprint 4): Compliance posture improved; optional fallback provider; email and DNC enhancements.

## Immediate next steps (48 hours)
1) DB path unification
   - Detect and migrate active DB from `backend/backend/data` to `backend/data`; update env and code to single path; backup + verify.
2) Backfill pipeline polish
   - Wire resume checkpoints; stable CLI flags; log runid; save reports to `run_reports/`.
3) Metrics + dashboards
   - Emit Prometheus counters/histograms; quick Grafana board; basic alerts (quota > 80%, error rate > 5%).
4) Idempotency + de-dupe
   - Compute key from normalized address + owner; check cache before provider call; persist key.
5) Tests
   - Adapter contract tests (v1/v2); cache/idempotency unit tests; CSV export snapshot test.

## Definition of done (representative)
- Backfill: runs with CONCURRENCY, produces OUT CSV, writes run report, zero demo artifacts, and logs costs.
- Server: prints provider URL and masked auth; metrics endpoint emits non-zero; debug routes gated in prod.
- Security: no secrets in repo or logs; role-based CSV access.

---
Owner: Michael A. Strickland
Date: 2025-09-18

---

## Progress to date (as of 2025-09-20)

- Single DB path in practice: server and scripts use `backend/data/convexa.db`. New helpers ensure consistent access.
- Idempotency/caching: added `ux_skiptrace_cache` unique index migration (provider,idempotency_key). Cache proof script updated (PASS).
- Reporting: canonicalized run report logic (normalized contact tables; schema-tolerant); CLI and HTTP endpoints aligned.
- Batch runners: stabilized `adHocRun.cjs` with schema-tolerant inserts/updates and normalized CSV export; added 20-lead CSV maker.
- Guardrails/admin: status endpoint and admin resume route working end-to-end; guardrails snapshot captured where available.
- Resume QA: executed a 20-lead run on isolated server (PORT=6031) and verified pause/resume to completion.
  - Run ID: d6e69500-6f2c-41b6-bec9-119898a68467
  - Bundle: `run_reports/<run_id>/qa_resume_smoke_bundle.zip` with status_before/after, report.json, guardrails_snapshot.json, enriched.csv (21 lines).

### Sprint 1 status (reality vs plan)

- Consolidate DB path → Done (operationally; code-paths honor `SQLITE_DB_PATH` and default to `backend/data/convexa.db`).
- Idempotency key + de-dupe → Implemented via unique index; provider logic computes idempotency and prevents double-billing.
- Mapping/response guard → In place in service; batch runner tolerates schema drift (no crashes on older DBs).
- Metrics → Basic Prometheus endpoint wired; requires dashboard wiring (see next steps).
- CLI backfill + verifier → Delivered via `adHocRun.cjs`, `generateRunReport.cjs`, and new `qaResumeSmoke.cjs`; reports saved to `run_reports/`.
- Tests → Partial; ad-hoc validation via orchestrator; unit tests still pending.

### Delivered artifacts

- `backend/integrated-server.js`: status endpoint hardening; admin routes mounted; metrics enabled when available.
- `scripts/adHocRun.cjs`: schema-tolerant batch runner; normalized CSV exporter.
- `scripts/generateRunReport.cjs`: canonical report generator (normalized tables; tolerant joins).
- `db/migrations/20250919_ux_skiptrace_cache.sql`: idempotent unique index on `skiptrace_cache(provider, idempotency_key)`.
- `scripts/qaResumeSmoke.cjs`: end-to-end resume smoke orchestrator (pause/resume, poll, artifacts, zip).
- `scripts/make20.cjs`, `scripts/getLatestRunId.cjs`, `scripts/forcePauseRun.cjs`, `scripts/killPort.cjs`: operational helpers (Windows-friendly).

### Gaps / open items

- Metrics dashboard: Grafana/alerts not yet set up; add panels for calls, costs, latency, cache hit-rate, daily budget.
- Automated tests: add contract tests for adapters, idempotency unit tests, and CSV/report snapshot tests.
- Frontend surfaces (Sprint 2): contact panel and export UI not wired yet; guardrails/quota dashboard pending.
- DB indices audit: confirm/create indices listed for Sprint 3 (created_at, lead_id combos) across tables.
- Security posture: RBAC for download endpoints; confirm PII redaction in logs and exports.

### Proposed next steps (prioritized)

1) Metrics & dashboards (O2/O3)
  - Add provider-labeled counters/histograms; wire a minimal Grafana board; alerts for quota >80%, error rate >5%.
2) Automated test coverage (O3)
  - Contract tests for BatchData adapter; idempotency/cache unit tests; report/CSV snapshot tests.
3) Frontend operator tooling (O5)
  - Simple export UI and artifact history view; quota/guardrails panel; error drill-down using `skip_trace_logs`.
4) Index & performance sweep (O2)
  - Verify and add missing indices for backfills; quick explain plans; set busy_timeout/synchronous defaults.
5) Security/RBAC (O4)
  - Gate artifact downloads; scrub PII in logs; document data export path.

Ownership: same as above; propose 1–2 day slice for metrics/tests, then UI work in parallel.
